<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gateway Cloning Tools - Currie Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Karla:wght@400;700&family=Molengo&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Molengo', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        h1, h2, h3, h4, .calculator-title, .info-title {
            font-family: 'Karla', sans-serif;
            font-weight: 700;
        }

        /* Main Navigation */
        .main-nav {
            background: #2c2c2c;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .lab-brand {
            color: #9d7f37;
            font-family: 'Karla', sans-serif;
            font-weight: 700;
            font-size: 1.3rem;
            text-decoration: none;
        }

        .main-tabs {
            display: flex;
            gap: 5px;
        }

        .main-tab {
            background: transparent;
            color: #ccc;
            border: 2px solid transparent;
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Karla', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .main-tab:hover {
            color: #9d7f37;
            border-color: #9d7f37;
        }

        .main-tab.active {
            background: #9d7f37;
            color: white;
            border-color: #9d7f37;
        }

        /* Tab Content */
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* ========== MULTISITE GATEWAY TOOL STYLES ========== */
        .gateway-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .gateway-header {
            background: linear-gradient(135deg, #9d7f37 0%, #7a6229 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .gateway-header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .gateway-header p {
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #fafafa;
            border-radius: 6px;
            padding: 20px;
        }

        .panel h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #9d7f37;
        }

        .element-input {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .element-input h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .element-input.element-5 h3 { color: #4A90E2; }
        .element-input.element-middle h3 { color: #7ED321; }
        .element-input.element-3 h3 { color: #F5A623; }
        .element-input.element-dest h3 { color: #9d7f37; }

        .pdonr-label {
            font-size: 1em;
            color: #888;
            margin-bottom: 8px;
            font-style: italic;
        }

        textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #9d7f37;
        }

        .checkbox-container {
            margin-top: 10px;
        }

        .checkbox-container label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #9d7f37;
        }

        .sequence-info {
            font-size: 1em;
            color: #666;
            margin-top: 5px;
        }

        .source-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .source-badge.raw {
            background: #e3f2fd;
            color: #1565c0;
        }

        .source-badge.entry {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .source-badge.dest {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        button {
            background: #9d7f37;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Karla', sans-serif;
            font-weight: 700;
            transition: background 0.3s;
        }

        button:hover {
            background: #7a6229;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error {
            color: #d32f2f;
            font-size: 1em;
            margin-top: 5px;
        }

        .workflow-diagram {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1em;
        }

        .workflow-step {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .workflow-step.bp-reaction {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
        }

        .workflow-step.lr-reaction {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
        }

        .workflow-arrow {
            text-align: center;
            color: #999;
            font-size: 1.2em;
            margin: 5px 0;
        }

        .sequence-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .seq-backbone { background-color: #e1bee7; }
        .seq-attb4 { background-color: #ffcdd2; }
        .seq-5element { background-color: #bbdefb; }
        .seq-attb1 { background-color: #f8bbd9; }
        .seq-middle { background-color: #c8e6c9; }
        .seq-attb2 { background-color: #ffe0b2; }
        .seq-3element { background-color: #fff9c4; }
        .seq-attb3 { background-color: #d1c4e9; }
        .seq-frame { background-color: #b2dfdb; text-decoration: underline; }

        .translation-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .translation-frame {
            font-family: 'Courier New', monospace;
            font-size: 1em;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .frame-label {
            font-weight: bold;
            color: #9d7f37;
        }

        .protein-seq {
            line-height: 1.8;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .start-codon { background-color: #c8e6c9; font-weight: bold; }
        .stop-codon { background-color: #ffcdd2; font-weight: bold; }
        .aa-from-5 { background-color: #bbdefb; }
        .aa-from-attb { background-color: #ffcdd2; }
        .aa-from-middle { background-color: #c8e6c9; }
        .aa-from-3 { background-color: #fff9c4; }
        .aa-from-frame { background-color: #b2dfdb; }

        .primer-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .primer-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-left: 3px solid #9d7f37;
        }

        .primer-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .primer-seq {
            font-family: 'Courier New', monospace;
            font-size: 1em;
            word-wrap: break-word;
            margin: 5px 0;
        }

        .primer-attb { color: #d32f2f; }
        .primer-gene { color: #1976d2; }

        .primer-info {
            font-size: 1em;
            color: #666;
        }

        .primer-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }

        .primer-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .primer-section-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        #vectorMap {
            width: 100%;
            max-width: 400px;
            height: 400px;
            margin: 0 auto;
            display: block;
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .export-buttons button {
            width: 100%;
        }

        .stats {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #555;
        }

        .stat-value {
            color: #9d7f37;
            font-weight: bold;
        }

        .att-site-info {
            background: #faf6ee;
            border: 1px solid #e0d5c0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .att-site-info h4 {
            color: #9d7f37;
            margin-bottom: 8px;
        }

        .att-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1em;
        }

        .att-table th, .att-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .att-table th {
            background: #f5efe3;
            font-weight: 600;
        }

        .att-table tr:last-child td {
            border-bottom: none;
        }

        /* ========== CALCULATOR STYLES ========== */
        .calculator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .calculator-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .calculator-header h1 {
            color: #9d7f37;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .subtitle {
            color: #666;
            font-size: 1rem;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        .calculator-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .calculator-title {
            font-size: 1.5rem;
            color: #9d7f37;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #9d7f37;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        input[type="number"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Molengo', sans-serif;
            transition: all 0.3s;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #9d7f37;
            box-shadow: 0 0 0 3px rgba(157, 127, 55, 0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-addon {
            background: #f5f5f5;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-weight: 600;
            color: #666;
            min-width: 80px;
            text-align: center;
        }

        .calculator-card button {
            background: linear-gradient(135deg, #9d7f37 0%, #7a6229 100%);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .calculator-card button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(157, 127, 55, 0.4);
        }

        .calculator-card button:active {
            transform: translateY(0);
        }

        .results {
            background: #faf6ee;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #9d7f37;
        }

        .results h3 {
            color: #9d7f37;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .result-item {
            background: white;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-label {
            font-weight: 600;
            color: #333;
        }

        .result-value {
            color: #9d7f37;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .info-box {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .info-title {
            color: #9d7f37;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .info-content {
            color: #666;
            line-height: 1.6;
        }

        .formula-box {
            background: #faf6ee;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #9d7f37;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .warning-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 5px;
        }

        .info-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .info-tab.active {
            background: #9d7f37;
            color: white;
        }

        .info-tab-content {
            display: none;
        }

        .info-tab-content.active {
            display: block;
        }

        /* ========== VECTOR VIEWER STYLES ========== */
        .viewer-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .viewer-header {
            background: linear-gradient(135deg, #9d7f37 0%, #7a6229 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .viewer-header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .viewer-controls {
            padding: 20px;
            background: #fafafa;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .viewer-controls label {
            font-weight: 600;
            color: #333;
        }

        .viewer-controls select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            min-width: 300px;
            font-family: 'Molengo', sans-serif;
        }

        .viewer-controls select:focus {
            outline: none;
            border-color: #9d7f37;
        }

        .upload-fallback {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 6px;
        }

        .upload-fallback:hover {
            border-color: #9d7f37;
        }

        .viewer-main {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 1000px) {
            .viewer-main {
                grid-template-columns: 1fr;
            }
        }

        .viewer-panel {
            background: #fafafa;
            border-radius: 6px;
            padding: 20px;
        }

        .viewer-panel h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #9d7f37;
        }

        .vector-info {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .vector-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .vector-info-item:last-child {
            border-bottom: none;
        }

        .vector-info-label {
            font-weight: 600;
            color: #555;
        }

        .vector-info-value {
            color: #9d7f37;
            font-weight: bold;
        }

        #circularMap {
            width: 100%;
            max-width: 360px;
            height: 360px;
            margin: 0 auto;
            display: block;
        }

        .linear-view-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        .linear-controls {
            padding: 10px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .linear-controls label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .linear-controls input[type="range"] {
            width: 150px;
            accent-color: #9d7f37;
        }

        .linear-controls input[type="number"] {
            width: 100px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .linear-controls button {
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .linear-view-scroll {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 15px;
        }

        #linearView {
            display: block;
            min-width: 100%;
        }

        .sequence-view {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }

        .sequence-line {
            display: flex;
            margin-bottom: 5px;
        }

        .sequence-position {
            width: 70px;
            color: #999;
            flex-shrink: 0;
            text-align: right;
            padding-right: 15px;
        }

        .sequence-text {
            word-break: break-all;
            letter-spacing: 1px;
        }

        .sequence-text span {
            padding: 1px 0;
        }

        .feature-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .feature-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .feature-item:hover {
            background: #f5f5f5;
        }

        .feature-item:last-child {
            border-bottom: none;
        }

        .feature-type {
            font-weight: 600;
            color: #333;
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-right: 8px;
        }

        .feature-type.CDS { background: #c8e6c9; color: #2e7d32; }
        .feature-type.gene { background: #bbdefb; color: #1565c0; }
        .feature-type.promoter { background: #fff9c4; color: #f57f17; }
        .feature-type.terminator { background: #ffcdd2; color: #c62828; }
        .feature-type.misc_feature { background: #e1bee7; color: #7b1fa2; }
        .feature-type.protein_bind { background: #b2dfdb; color: #00695c; }
        .feature-type.rep_origin { background: #ffe0b2; color: #e65100; }
        .feature-type.primer_bind { background: #f5f5f5; color: #616161; }

        .feature-name {
            font-weight: 500;
            color: #333;
        }

        .feature-location {
            font-size: 0.85em;
            color: #666;
            margin-top: 3px;
        }

        .no-vector-message {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Main Navigation -->
    <nav class="main-nav">
        <a href="#" class="lab-brand">Currie Lab Gateway Tools</a>
        <div class="main-tabs">
            <button class="main-tab active" onclick="showMainTab('gateway')">MultiSite Gateway Tool</button>
            <button class="main-tab" onclick="showMainTab('calculator')">Cloning Calculator</button>
            <button class="main-tab" onclick="showMainTab('viewer')">Vector Viewer</button>
        </div>
    </nav>

    <!-- ========== MULTISITE GATEWAY TOOL ========== -->
    <div id="gateway-panel" class="tab-panel active">
        <div class="gateway-container">
            <div class="gateway-header">
                <h1>MultiSite Gateway Cloning Tool</h1>
                <p>Design your multisite gateway cloning experiments with proper BP/LR recombination modeling</p>
            </div>

            <div class="main-content">
                <!-- Left Panel: Inputs -->
                <div class="panel">
                    <h2>Sequence Inputs</h2>

                    <div class="att-site-info">
                        <h4>Gateway Cloning Workflow</h4>
                        <p>Upload Entry clones or enter raw sequences. Raw sequences receive attB primers for BP reaction.
                        The LR reaction combines Entry clones with pDEST to create the final Expression clone.</p>
                    </div>

                    <div class="element-input element-dest">
                        <h3>Destination Vector (pDEST)</h3>
                        <div class="pdonr-label">Upload pDEST vector with attR4 and attR3 sites</div>
                        <div style="margin: 10px 0;">
                            <input type="file" id="fileDest" accept=".gb,.gbk" style="display: none;">
                            <button onclick="document.getElementById('fileDest').click()" type="button" style="width: 100%; padding: 8px;">Upload pDEST Vector (.gb)</button>
                        </div>
                        <div class="sequence-info" id="infoDest">No vector loaded</div>
                        <div class="error" id="errorDest"></div>
                    </div>

                    <div class="element-input element-5">
                        <h3>5' Element (Promoter)</h3>
                        <div class="pdonr-label">pDONR P4-P1R Entry Clone (attL4-insert-attR1) or raw sequence</div>
                        <textarea id="seq5" placeholder="Enter DNA sequence or upload Entry clone..."></textarea>
                        <div style="margin: 10px 0;">
                            <input type="file" id="file5" accept=".gb,.gbk" style="display: none;">
                            <button onclick="document.getElementById('file5').click()" type="button" style="width: 100%; padding: 8px;">Upload Entry Clone (.gb)</button>
                        </div>
                        <div class="sequence-info" id="info5">Length: 0 bp <span id="source5"></span></div>
                        <div class="error" id="error5"></div>
                        <div class="checkbox-container">
                            <label>
                                <input type="checkbox" id="frame5">
                                <span>Keep in frame with middle element</span>
                            </label>
                        </div>
                    </div>

                    <div class="element-input element-middle">
                        <h3>Middle Element (Gene of Interest)</h3>
                        <div class="pdonr-label">pDONR 221 Entry Clone (attL1-insert-attL2) or raw sequence</div>
                        <textarea id="seqMiddle" placeholder="Enter DNA sequence or upload Entry clone..."></textarea>
                        <div style="margin: 10px 0;">
                            <input type="file" id="fileMiddle" accept=".gb,.gbk" style="display: none;">
                            <button onclick="document.getElementById('fileMiddle').click()" type="button" style="width: 100%; padding: 8px;">Upload Entry Clone (.gb)</button>
                        </div>
                        <div class="sequence-info" id="infoMiddle">Length: 0 bp <span id="sourceMiddle"></span></div>
                        <div class="error" id="errorMiddle"></div>
                    </div>

                    <div class="element-input element-3">
                        <h3>3' Element (Terminator/Tag)</h3>
                        <div class="pdonr-label">pDONR P2R-P3 Entry Clone (attR2-insert-attL3) or raw sequence</div>
                        <textarea id="seq3" placeholder="Enter DNA sequence or upload Entry clone..."></textarea>
                        <div style="margin: 10px 0;">
                            <input type="file" id="file3" accept=".gb,.gbk" style="display: none;">
                            <button onclick="document.getElementById('file3').click()" type="button" style="width: 100%; padding: 8px;">Upload Entry Clone (.gb)</button>
                        </div>
                        <div class="sequence-info" id="info3">Length: 0 bp <span id="source3"></span></div>
                        <div class="error" id="error3"></div>
                        <div class="checkbox-container">
                            <label>
                                <input type="checkbox" id="frame3">
                                <span>Keep in frame with middle element</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="assembleSequences()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                        Generate Assembly & Primers
                    </button>
                </div>

                <!-- Center Panel: Visualization -->
                <div class="panel">
                    <h2>Gateway Reaction Workflow</h2>
                    <div id="workflowDisplay" class="workflow-diagram">
                        <p style="color: #999; text-align: center;">Enter sequences and click "Generate Assembly & Primers" to see the reaction workflow</p>
                    </div>

                    <h2>Expression Clone Sequence</h2>
                    <div id="assemblyDisplay" class="sequence-display">
                        <p style="color: #999; text-align: center;">Final expression clone sequence will appear here</p>
                    </div>

                    <h2>Translation (Longest ORF from Middle Element)</h2>
                    <div id="translationDisplay" class="translation-display">
                        <p style="color: #999; text-align: center;">Translation will appear here after assembly</p>
                    </div>

                    <h2>Statistics</h2>
                    <div id="statsDisplay" class="stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Assembly Size:</span>
                            <span class="stat-value" id="statSize">0 bp</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">GC Content:</span>
                            <span class="stat-value" id="statGC">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Molecular Weight:</span>
                            <span class="stat-value" id="statMW">0 Da</span>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Primers & Export -->
                <div class="panel">
                    <h2>attB Site Reference</h2>
                    <div class="att-site-info">
                        <table class="att-table">
                            <tr><th>Site</th><th>Sequence (5'->3')</th></tr>
                            <tr><td>attB4</td><td style="font-family: monospace;">GGGGACAACTTTGTATAGAAAAGTTG</td></tr>
                            <tr><td>attB1r</td><td style="font-family: monospace;">GGGGACTGCTTTTTTGTACAAACTTG</td></tr>
                            <tr><td>attB1</td><td style="font-family: monospace;">GGGGACAAGTTTGTACAAAAAAGCAGGCT</td></tr>
                            <tr><td>attB2</td><td style="font-family: monospace;">GGGGACCACTTTGTACAAGAAAGCTGGGT</td></tr>
                            <tr><td>attB2r</td><td style="font-family: monospace;">GGGGACAGCTTTCTTGTACAAAGTGG</td></tr>
                            <tr><td>attB3</td><td style="font-family: monospace;">GGGGACAACTTTGTATAATAAAGTTG</td></tr>
                        </table>
                    </div>

                    <h2>PCR Primers</h2>
                    <div id="primerDisplay" class="primer-list">
                        <p style="color: #999; text-align: center;">Primers for BP reaction will be generated after assembly</p>
                    </div>

                    <h2>Vector Map</h2>
                    <svg id="vectorMap"></svg>

                    <h2>Export</h2>
                    <div class="export-buttons">
                        <button onclick="exportFASTA()">Download FASTA</button>
                        <button onclick="exportGenBank()">Download GenBank</button>
                        <button onclick="exportPrimers()">Download Primers (CSV)</button>
                        <button onclick="exportReport()">Download Report (TXT)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== CLONING CALCULATOR ========== -->
    <div id="calculator-panel" class="tab-panel">
        <div class="calculator-container">
            <div class="calculator-header">
                <h1>Gateway Cloning Calculator</h1>
                <p class="subtitle">MultiSite Gateway Three-Fragment Vector Construction Kit</p>
            </div>

            <div class="calculator-grid">
                <!-- BP Reaction Calculator -->
                <div class="calculator-card">
                    <h2 class="calculator-title">BP Recombination Reaction</h2>

                    <div class="form-group">
                        <label>PCR Product Size (bp)</label>
                        <div class="input-group">
                            <input type="number" id="bp-pcr-size" placeholder="e.g., 2500" min="1">
                            <span class="input-addon">bp</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Desired Amount (fmoles)</label>
                        <div class="input-group">
                            <input type="number" id="bp-fmoles" value="50" min="20" max="50" step="1">
                            <span class="input-addon">fmoles</span>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">Recommended: 20-50 fmoles (50 preferred)</small>
                    </div>

                    <div class="form-group">
                        <label>Donor Vector Type</label>
                        <select id="bp-donor-type">
                            <option value="p4p1r">pDONR P4-P1R (attB4/attB1r)</option>
                            <option value="221">pDONR 221 (attB1/attB2)</option>
                            <option value="p2rp3">pDONR P2R-P3 (attB2r/attB3)</option>
                        </select>
                    </div>

                    <button onclick="calculateBP()">Calculate BP Reaction</button>

                    <div id="bp-results" style="display: none;" class="results">
                        <h3>BP Reaction Components (10 ul total)</h3>
                        <div class="result-item">
                            <span class="result-label">attB PCR Product</span>
                            <span class="result-value" id="bp-pcr-volume">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">pDONR Vector (150 ng/ul)</span>
                            <span class="result-value">1 ul</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">TE Buffer, pH 8.0</span>
                            <span class="result-value" id="bp-te-volume">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">BP Clonase II enzyme mix</span>
                            <span class="result-value">2 ul</span>
                        </div>
                        <div class="warning">
                            <div class="warning-title">Important Guidelines</div>
                            <small>- Total DNA should not exceed 500 ng in 10 ul reaction<br>
                            - For PCR products >= 5 kb, incubate overnight<br>
                            - Incubate at 25C for 1 hour (or up to 18 hours)<br>
                            - Add 1 ul Proteinase K after incubation, incubate 37C for 10 min</small>
                        </div>
                    </div>
                </div>

                <!-- LR Reaction Calculator -->
                <div class="calculator-card">
                    <h2 class="calculator-title">MultiSite Gateway LR Reaction</h2>

                    <div class="form-group">
                        <label>Entry Clone 1 Size (attL4-attR1) (bp)</label>
                        <div class="input-group">
                            <input type="number" id="lr-entry1-size" placeholder="e.g., 3000" min="1">
                            <span class="input-addon">bp</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Entry Clone 2 Size (attL1-attL2) (bp)</label>
                        <div class="input-group">
                            <input type="number" id="lr-entry2-size" placeholder="e.g., 1500" min="1">
                            <span class="input-addon">bp</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Entry Clone 3 Size (attR2-attL3) (bp)</label>
                        <div class="input-group">
                            <input type="number" id="lr-entry3-size" placeholder="e.g., 2000" min="1">
                            <span class="input-addon">bp</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Amount per Entry Clone (fmoles)</label>
                        <div class="input-group">
                            <input type="number" id="lr-entry-fmoles" value="10" min="1" step="1">
                            <span class="input-addon">fmoles</span>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">Recommended: 10 fmoles each</small>
                    </div>

                    <button onclick="calculateLR()">Calculate LR Reaction</button>

                    <div id="lr-results" style="display: none;" class="results">
                        <h3>LR Reaction Components (10 ul total)</h3>
                        <div class="result-item">
                            <span class="result-label">Entry Clone 1 (attL4-attR1)</span>
                            <span class="result-value" id="lr-entry1-volume">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Entry Clone 2 (attL1-attL2)</span>
                            <span class="result-value" id="lr-entry2-volume">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Entry Clone 3 (attR2-attL3)</span>
                            <span class="result-value" id="lr-entry3-volume">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">pDEST R4-R3 Vector II (150 ng/ul)</span>
                            <span class="result-value" id="lr-dest-volume">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">TE Buffer, pH 8.0</span>
                            <span class="result-value" id="lr-te-volume">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">LR Clonase II Plus enzyme mix</span>
                            <span class="result-value">2 ul</span>
                        </div>
                        <div class="warning">
                            <div class="warning-title">Important Guidelines</div>
                            <small>- Total DNA should not exceed 60 fmoles in 10 ul reaction<br>
                            - Incubate at 25C for 16 hours (overnight)<br>
                            - Add 1 ul Proteinase K after incubation, incubate 37C for 10 min<br>
                            - Use LR Clonase II Plus (not LR Clonase or LR Clonase II)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Information Section -->
            <div class="info-box">
                <h3 class="info-title">Conversion Formula</h3>
                <div class="info-content">
                    <p>The manual provides the following formula to convert femtomoles (fmoles) to nanograms (ng):</p>
                    <div class="formula-box">
                        ng = (fmoles) x (N bp) x (660 fg/fmole) x (1 ng / 10^6 fg)
                    </div>
                    <p style="margin-top: 10px;"><strong>Where:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>fmoles = desired amount in femtomoles</li>
                        <li>N = size of DNA in base pairs (bp)</li>
                        <li>660 fg = approximate mass of 1 bp double-stranded DNA</li>
                    </ul>

                    <p style="margin-top: 15px;"><strong>Example from manual:</strong> 50 fmoles of a 2.5 kb PCR product:</p>
                    <div class="formula-box">
                        ng = (50 fmoles) x (2,500 bp) x (660 fg/fmole) x (1 ng / 10^6 fg) = 82.5 ng
                    </div>
                </div>
            </div>

            <div class="info-box">
                <h3 class="info-title">Key Guidelines</h3>
                <div class="info-content">
                    <div class="info-tabs">
                        <button class="info-tab active" onclick="showInfoTab('bp-guidelines')">BP Reaction</button>
                        <button class="info-tab" onclick="showInfoTab('lr-guidelines')">LR Reaction</button>
                    </div>

                    <div id="bp-guidelines" class="info-tab-content active">
                        <h4 style="color: #9d7f37; margin-bottom: 10px;">BP Recombination Reaction Guidelines</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>DNA Amount:</strong> Use equimolar amounts of attB PCR product and donor vector</li>
                            <li><strong>Preferred:</strong> 50 fmoles each, but may range from 20-50 fmoles for PCR product</li>
                            <li><strong>Large PCR products (>4 kb):</strong> Use at least 50 fmoles, but no more than 250 ng</li>
                            <li><strong>Total DNA Limit:</strong> Do not exceed 500 ng total DNA (donor + PCR product)</li>
                            <li><strong>Donor Vector Limit:</strong> Do not use more than 250 ng in 10 ul reaction</li>
                            <li><strong>Incubation:</strong> 1 hour at 25C (up to 18 hours for increased yield)</li>
                            <li><strong>Transform:</strong> 1 ul into competent cells; plate 20 ul and 100 ul</li>
                        </ul>
                    </div>

                    <div id="lr-guidelines" class="info-tab-content">
                        <h4 style="color: #9d7f37; margin-bottom: 10px;">MultiSite Gateway LR Reaction Guidelines</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>DNA Amount:</strong> Use equimolar amounts of all plasmids</li>
                            <li><strong>Recommended:</strong> 10 fmoles of each entry clone and 20 fmoles of destination vector</li>
                            <li><strong>Total DNA Limit:</strong> Do not exceed 60 fmoles total plasmid DNA</li>
                            <li><strong>Entry Clones:</strong> Must be supercoiled and highly purified</li>
                            <li><strong>Required Entry Clones:</strong> attL4-attR1, attL1-attL2, and attR2-attL3</li>
                            <li><strong>Destination Vector:</strong> Must use pDEST R4-R3 Vector II</li>
                            <li><strong>Incubation:</strong> 16 hours (overnight) at 25C</li>
                            <li><strong>Transform:</strong> 2 ul into competent cells; plate 50 ul and 100 ul</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== VECTOR VIEWER ========== -->
    <div id="viewer-panel" class="tab-panel">
        <div class="viewer-container">
            <div class="viewer-header">
                <h1>Gateway Vector Viewer</h1>
                <p>Visualize and explore Gateway cloning vectors</p>
            </div>

            <div class="viewer-controls">
                <div>
                    <label for="vectorSelect">Select Vector: </label>
                    <select id="vectorSelect" onchange="loadSelectedVector()">
                        <option value="">-- Choose a vector --</option>
                    </select>
                </div>
                <div class="upload-fallback">
                    <label>Or upload: </label>
                    <input type="file" id="viewerFileUpload" accept=".gb,.gbk" onchange="loadUploadedVector(event)">
                </div>
                <div id="vectorLoadStatus"></div>
            </div>

            <div id="viewerContent" style="display: none;">
                <div class="viewer-main">
                    <!-- Left Panel: Circular Map & Info -->
                    <div class="viewer-panel">
                        <h2>Vector Information</h2>
                        <div class="vector-info">
                            <div class="vector-info-item">
                                <span class="vector-info-label">Name:</span>
                                <span class="vector-info-value" id="viewerVectorName">-</span>
                            </div>
                            <div class="vector-info-item">
                                <span class="vector-info-label">Size:</span>
                                <span class="vector-info-value" id="viewerVectorSize">-</span>
                            </div>
                            <div class="vector-info-item">
                                <span class="vector-info-label">Type:</span>
                                <span class="vector-info-value" id="viewerVectorType">-</span>
                            </div>
                            <div class="vector-info-item">
                                <span class="vector-info-label">GC Content:</span>
                                <span class="vector-info-value" id="viewerGC">-</span>
                            </div>
                        </div>

                        <h2>Circular Map</h2>
                        <svg id="circularMap"></svg>

                        <h2>Features (<span id="featureCount">0</span>)</h2>
                        <div class="feature-list" id="featureList">
                            <div class="no-vector-message">Select a vector to view features</div>
                        </div>
                    </div>

                    <!-- Right Panel: Linear View & Sequence -->
                    <div class="viewer-panel" style="overflow: hidden;">
                        <h2>Linear Map</h2>
                        <div class="linear-view-container">
                            <div class="linear-controls">
                                <label>Zoom: </label>
                                <input type="range" id="linearZoom" min="1" max="20" value="1" onchange="updateLinearView()">
                                <span id="zoomLevel">1x</span>

                                <label style="margin-left: 20px;">Go to position: </label>
                                <input type="number" id="gotoPosition" min="1" placeholder="bp">
                                <button onclick="goToPosition()">Go</button>
                            </div>
                            <div class="linear-view-scroll" id="linearViewScroll">
                                <svg id="linearView"></svg>
                            </div>
                        </div>

                        <h2>Sequence</h2>
                        <div class="linear-controls" style="background: #f5f5f5; padding: 10px 15px; border-radius: 6px 6px 0 0;">
                            <label>Show region: </label>
                            <input type="number" id="seqStart" min="1" value="1" style="width: 80px;"> -
                            <input type="number" id="seqEnd" min="1" value="500" style="width: 80px;">
                            <button onclick="updateSequenceView()">Show</button>
                            <button onclick="showFullSequence()">Show All</button>
                        </div>
                        <div class="sequence-view" id="sequenceView">
                            <div class="no-vector-message">Select a vector to view sequence</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="viewerPlaceholder" class="no-vector-message" style="padding: 60px;">
                <h3 style="color: #666; margin-bottom: 10px;">No Vector Selected</h3>
                <p>Choose a vector from the dropdown above or upload a GenBank file to visualize it.</p>
            </div>
        </div>
    </div>

    <script>
        // ========== TAB NAVIGATION ==========
        function showMainTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Deactivate all tabs
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected panel
            document.getElementById(tabName + '-panel').classList.add('active');

            // Activate selected tab
            event.target.classList.add('active');
        }

        function showInfoTab(tabId) {
            // Hide all info tab contents
            document.querySelectorAll('.info-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all info tabs
            document.querySelectorAll('.info-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabId).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // ========== CALCULATOR FUNCTIONS ==========
        function fmolesToNg(fmoles, basePairs) {
            return fmoles * basePairs * 660 / 1000000;
        }

        function calculateBP() {
            const pcrSize = parseFloat(document.getElementById('bp-pcr-size').value);
            const fmoles = parseFloat(document.getElementById('bp-fmoles').value);

            if (!pcrSize || !fmoles) {
                alert('Please enter both PCR product size and desired amount');
                return;
            }

            if (fmoles < 20 || fmoles > 50) {
                if (!confirm('Recommended range is 20-50 fmoles. Continue anyway?')) {
                    return;
                }
            }

            const pcrNg = fmolesToNg(fmoles, pcrSize);

            if (pcrSize >= 4000 && pcrNg > 250) {
                alert('Warning: For large PCR products (>=4 kb), do not exceed 250 ng.\nCalculated amount: ' + pcrNg.toFixed(2) + ' ng');
                return;
            }

            const donorNg = 150;
            const totalDna = pcrNg + donorNg;
            if (totalDna > 500) {
                alert('Warning: Total DNA (' + totalDna.toFixed(2) + ' ng) exceeds 500 ng limit.\nPlease reduce the amount of PCR product.');
                return;
            }

            const pcrVolume = pcrNg.toFixed(2) + ' ng (1-7 ul)';
            const teVolume = 'to 8 ul';

            document.getElementById('bp-pcr-volume').textContent = pcrVolume;
            document.getElementById('bp-te-volume').textContent = teVolume;
            document.getElementById('bp-results').style.display = 'block';

            document.getElementById('bp-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function calculateLR() {
            const entry1Size = parseFloat(document.getElementById('lr-entry1-size').value);
            const entry2Size = parseFloat(document.getElementById('lr-entry2-size').value);
            const entry3Size = parseFloat(document.getElementById('lr-entry3-size').value);
            const entryFmoles = parseFloat(document.getElementById('lr-entry-fmoles').value);

            if (!entry1Size || !entry2Size || !entry3Size || !entryFmoles) {
                alert('Please enter all entry clone sizes and desired amount');
                return;
            }

            const entry1Ng = fmolesToNg(entryFmoles, entry1Size);
            const entry2Ng = fmolesToNg(entryFmoles, entry2Size);
            const entry3Ng = fmolesToNg(entryFmoles, entry3Size);

            const destFmoles = 20;
            const destSize = 4555;
            const destNg = fmolesToNg(destFmoles, destSize);
            const destVolume = (destNg / 150).toFixed(2);

            const totalFmoles = (entryFmoles * 3) + destFmoles;
            if (totalFmoles > 60) {
                alert('Warning: Total DNA (' + totalFmoles.toFixed(2) + ' fmoles) exceeds 60 fmoles limit.\nPlease reduce the amount per entry clone.');
                return;
            }

            document.getElementById('lr-entry1-volume').textContent = entry1Ng.toFixed(2) + ' ng';
            document.getElementById('lr-entry2-volume').textContent = entry2Ng.toFixed(2) + ' ng';
            document.getElementById('lr-entry3-volume').textContent = entry3Ng.toFixed(2) + ' ng';
            document.getElementById('lr-dest-volume').textContent = destVolume + ' ul (' + destNg.toFixed(2) + ' ng)';
            document.getElementById('lr-te-volume').textContent = 'to 8 ul (total 1-7 ul entries + dest)';
            document.getElementById('lr-results').style.display = 'block';

            document.getElementById('lr-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ========== MULTISITE GATEWAY TOOL FUNCTIONS ==========
        // Global variables to store assembled data
        let assembledData = null;

        // Track sequence sources (raw input vs entry clone upload)
        let sequenceSources = {
            '5': 'raw',
            'middle': 'raw',
            '3': 'raw'
        };

        // Store pDEST backbone data
        let destVectorData = null;

        // attB sequences for PCR primers (from MultiSite Gateway manual page vi)
        const attBPrimerSequences = {
            attB4: 'GGGGACAACTTTGTATAGAAAAGTTG',
            attB1r: 'GGGGACTGCTTTTTTGTACAAACTTG',
            attB1: 'GGGGACAAGTTTGTACAAAAAAGCAGGCT',
            attB2: 'GGGGACCACTTTGTACAAGAAAGCTGGGT',
            attB2r: 'GGGGACAGCTTTCTTGTACAAAGTGG',
            attB3: 'GGGGACAACTTTGTATAATAAAGTTG'
        };

        // Recombined attB sites in the final Expression clone after LR reaction
        const attBRecombinedSequences = {
            attB4: 'ACAACTTTGTATAGAAAAGTTG',
            attB1: 'ACAAGTTTGTACAAAAAAGCAGGCT',
            attB2: 'ACCACTTTGTACAAGAAAGCTGGGT',
            attB3: 'ACAACTTTGTATAATAAAGTTG'
        };

        // Codon table
        const codonTable = {
            'TTT': 'F', 'TTC': 'F', 'TTA': 'L', 'TTG': 'L',
            'TCT': 'S', 'TCC': 'S', 'TCA': 'S', 'TCG': 'S',
            'TAT': 'Y', 'TAC': 'Y', 'TAA': '*', 'TAG': '*',
            'TGT': 'C', 'TGC': 'C', 'TGA': '*', 'TGG': 'W',
            'CTT': 'L', 'CTC': 'L', 'CTA': 'L', 'CTG': 'L',
            'CCT': 'P', 'CCC': 'P', 'CCA': 'P', 'CCG': 'P',
            'CAT': 'H', 'CAC': 'H', 'CAA': 'Q', 'CAG': 'Q',
            'CGT': 'R', 'CGC': 'R', 'CGA': 'R', 'CGG': 'R',
            'ATT': 'I', 'ATC': 'I', 'ATA': 'I', 'ATG': 'M',
            'ACT': 'T', 'ACC': 'T', 'ACA': 'T', 'ACG': 'T',
            'AAT': 'N', 'AAC': 'N', 'AAA': 'K', 'AAG': 'K',
            'AGT': 'S', 'AGC': 'S', 'AGA': 'R', 'AGG': 'R',
            'GTT': 'V', 'GTC': 'V', 'GTA': 'V', 'GTG': 'V',
            'GCT': 'A', 'GCC': 'A', 'GCA': 'A', 'GCG': 'A',
            'GAT': 'D', 'GAC': 'D', 'GAA': 'E', 'GAG': 'E',
            'GGT': 'G', 'GGC': 'G', 'GGA': 'G', 'GGG': 'G'
        };

        // Global storage for features from uploaded files
        let entryFeatures = {
            '5': [],
            'middle': [],
            '3': []
        };
        let destFeatures = [];

        // Parse pDEST vector to extract backbone
        function parseDestVector(fileContent) {
            try {
                const originMatch = fileContent.match(/ORIGIN\s+([\s\S]+?)\/\//);
                if (!originMatch) {
                    throw new Error('Could not find ORIGIN section in GenBank file');
                }

                const fullSequence = originMatch[1]
                    .replace(/\d+/g, '')
                    .replace(/\s+/g, '')
                    .toUpperCase();

                const attR4StartMarkers = [
                    'TCAACTTTGTATAGAAAAGTTG',
                    'CAACTTTGTATAGAAAAGTTG',
                    'AACTTTGTATAGAAAAGTTG',
                    'CTTTGTATAGAAAAGTTG'
                ];

                const attR3EndMarkers = [
                    'CAACTTTATTATACATAGTTG',
                    'CAACTTTATTATACATAGT',
                    'ACTTTATTATACATAGTTG',
                    'CTTTATTATACATAGTTG'
                ];

                let attR4Start = null;
                let attR3End = null;
                let markerR4Start = null;
                let markerR3End = null;

                for (const marker of attR4StartMarkers) {
                    const idx = fullSequence.indexOf(marker);
                    if (idx !== -1) {
                        markerR4Start = idx;
                        break;
                    }
                }

                for (const marker of attR3EndMarkers) {
                    const searchStart = markerR4Start !== null ? markerR4Start + 100 : 0;
                    const idx = fullSequence.indexOf(marker, searchStart);
                    if (idx !== -1) {
                        markerR3End = idx + marker.length;
                        break;
                    }
                }

                if (markerR4Start !== null && markerR3End !== null) {
                    attR4Start = markerR4Start;
                    attR3End = markerR3End;
                }

                if (attR4Start === null || attR3End === null) {
                    throw new Error('Could not find attR4 and attR3 sites in pDEST vector.');
                }

                if (attR4Start > attR3End) {
                    throw new Error('attR4 appears after attR3 in the sequence - unexpected pDEST structure');
                }

                const backbone5 = fullSequence.substring(0, attR4Start);
                const backbone3 = fullSequence.substring(attR3End);

                const allFeatures = parseGenbankFeatures(fileContent);

                const backbone5Features = allFeatures
                    .filter(f => f.end <= attR4Start)
                    .filter(f => {
                        const label = (f.qualifiers.label || '').toLowerCase();
                        return !label.includes('attr4') && !label.includes('attr3');
                    })
                    .map(f => ({
                        ...f,
                        source: 'dest_5prime'
                    }));

                const backbone3Features = allFeatures
                    .filter(f => f.start > attR3End)
                    .filter(f => {
                        const label = (f.qualifiers.label || '').toLowerCase();
                        return !label.includes('attr4') && !label.includes('attr3');
                    })
                    .map(f => ({
                        ...f,
                        originalStart: f.start,
                        originalEnd: f.end,
                        start: f.start - attR3End,
                        end: f.end - attR3End,
                        source: 'dest_3prime'
                    }));

                return {
                    fullSequence: fullSequence,
                    backbone5: backbone5,
                    backbone3: backbone3,
                    backbone5Features: backbone5Features,
                    backbone3Features: backbone3Features,
                    attR4Start: attR4Start,
                    attR3End: attR3End,
                    name: extractPlasmidName(fileContent)
                };
            } catch (error) {
                throw new Error(`pDEST parsing error: ${error.message}`);
            }
        }

        function extractPlasmidName(fileContent) {
            const locusMatch = fileContent.match(/LOCUS\s+(\S+)/);
            if (locusMatch) return locusMatch[1];
            const defMatch = fileContent.match(/DEFINITION\s+(.+)/);
            if (defMatch) return defMatch[1].trim();
            return 'pDEST';
        }

        // Parse GenBank features from file content
        function parseGenbankFeatures(fileContent) {
            const features = [];
            const featuresMatch = fileContent.match(/FEATURES\s+Location\/Qualifiers([\s\S]*?)(?=ORIGIN)/);
            if (!featuresMatch) return features;

            const featuresText = featuresMatch[1];
            const lines = featuresText.split('\n');
            let currentFeature = null;
            let currentQualifiers = '';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const featureMatch = line.match(/^\s{5}(\S+)\s+((?:complement\()?(?:join\()?[\d.<>,]+\)?)\s*$/);

                if (featureMatch) {
                    if (currentFeature) {
                        currentFeature.qualifiers = parseQualifiers(currentQualifiers);
                        features.push(currentFeature);
                    }

                    const featureType = featureMatch[1];
                    const locationStr = featureMatch[2];
                    const location = parseFeatureLocation(locationStr);

                    currentFeature = {
                        type: featureType,
                        locationStr: locationStr,
                        start: location.start,
                        end: location.end,
                        complement: location.complement,
                        join: location.join,
                        qualifiers: {}
                    };
                    currentQualifiers = '';
                } else if (currentFeature && line.match(/^\s{21}/)) {
                    currentQualifiers += line.trim() + '\n';
                }
            }

            if (currentFeature) {
                currentFeature.qualifiers = parseQualifiers(currentQualifiers);
                features.push(currentFeature);
            }

            return features;
        }

        function parseFeatureLocation(locationStr) {
            let complement = false;
            let join = false;
            let start = 0;
            let end = 0;

            let workStr = locationStr;

            if (workStr.startsWith('complement(')) {
                complement = true;
                workStr = workStr.replace(/^complement\(/, '').replace(/\)$/, '');
            }

            if (workStr.startsWith('join(')) {
                join = true;
                workStr = workStr.replace(/^join\(/, '').replace(/\)$/, '');
            }

            const simpleMatch = workStr.match(/^<?(\d+)\.\.>?(\d+)$/);
            if (simpleMatch) {
                start = parseInt(simpleMatch[1]);
                end = parseInt(simpleMatch[2]);
            } else if (join) {
                const positions = workStr.match(/(\d+)/g);
                if (positions && positions.length >= 2) {
                    start = parseInt(positions[0]);
                    end = parseInt(positions[positions.length - 1]);
                }
            } else {
                const singleMatch = workStr.match(/(\d+)/);
                if (singleMatch) {
                    start = end = parseInt(singleMatch[1]);
                }
            }

            return { start, end, complement, join };
        }

        function parseQualifiers(qualifiersText) {
            const qualifiers = {};
            const lines = qualifiersText.split('\n');

            let currentKey = null;
            let currentValue = '';

            for (const line of lines) {
                if (!line.trim()) continue;

                const qualMatch = line.match(/^\/(\w+)(?:=(.*))?$/);
                if (qualMatch) {
                    if (currentKey) {
                        qualifiers[currentKey] = currentValue.replace(/^"/, '').replace(/"$/, '');
                    }

                    currentKey = qualMatch[1];
                    currentValue = qualMatch[2] || 'true';
                } else if (currentKey) {
                    currentValue += line;
                }
            }

            if (currentKey) {
                qualifiers[currentKey] = currentValue.replace(/^"/, '').replace(/"$/, '');
            }

            return qualifiers;
        }

        // Parse Entry clone to extract insert between attL and attR sites
        function parseEntryClone(fileContent, elementType) {
            try {
                const originMatch = fileContent.match(/ORIGIN\s+([\s\S]+?)\/\//);
                if (!originMatch) {
                    throw new Error('Could not find ORIGIN section in GenBank file');
                }

                const fullSequence = originMatch[1]
                    .replace(/\d+/g, '')
                    .replace(/\s+/g, '')
                    .toUpperCase();

                const attConfig = {
                    '5': {
                        startSite: 'attL4',
                        endSite: 'attR1',
                        startMarkers: [
                            'CCAACTTTGTATAGAAAAGTTG',
                            'AACTTTGTATAGAAAAGTTG',
                            'CTTTGTATAGAAAAGTTG',
                            'TTTGTATAGAAAAGTTG',
                            'GTATAGAAAAGTTG'
                        ],
                        endMarkers: [
                            'CAAGTTTGTACAAAAAAGTTG',
                            'AAGTTTGTACAAAAAAGTTG',
                            'AGTTTGTACAAAAAAGTTG',
                            'GTTTGTACAAAAAAGTTG',
                            'TTTGTACAAAAAAGTTG'
                        ]
                    },
                    'middle': {
                        startSite: 'attL1',
                        endSite: 'attL2',
                        startMarkers: [
                            'CCAACTTTGTACAAAAAAGCAGGCT',
                            'AACTTTGTACAAAAAAGCAGGCT',
                            'CTTTGTACAAAAAAGCAGGCT',
                            'TTTGTACAAAAAAGCAGGCT',
                            'GTACAAAAAAGCAGGCT'
                        ],
                        endMarkers: [
                            'TCCCAGCTTTCTTGTACAAAGTTGGC',
                            'CCCAGCTTTCTTGTACAAAGTTGGC',
                            'CCAGCTTTCTTGTACAAAGTTGGC',
                            'CAGCTTTCTTGTACAAAGTTGGC',
                            'AGCTTTCTTGTACAAAGTTGGC'
                        ]
                    },
                    '3': {
                        startSite: 'attR2',
                        endSite: 'attL3',
                        startMarkers: [
                            'GTTCAACTTTCTTGTACAAAGTGG',
                            'CAACTTTCTTGTACAAAGTGG',
                            'TTTCTTGTACAAAGTGG',
                            'CTTGTACAAAGTGG',
                            'TGTACAAAGTGG'
                        ],
                        endMarkers: [
                            'ACAACTTTATTATACAAAGTTG',
                            'CAACTTTATTATACAAAGTTG',
                            'ACTTTATTATACAAAGTTG',
                            'TTTATTATACAAAGTTG',
                            'TTATTATACAAAGTTG'
                        ]
                    }
                };

                const config = attConfig[elementType];
                if (!config) {
                    throw new Error('Invalid element type');
                }

                let insertStart = null, insertEnd = null;
                let markerStart = null, markerEnd = null;

                for (const marker of config.startMarkers) {
                    const idx = fullSequence.indexOf(marker);
                    if (idx !== -1) {
                        markerStart = idx + marker.length;
                        break;
                    }
                }

                for (const marker of config.endMarkers) {
                    const searchStart = markerStart !== null ? markerStart : 0;
                    const idx = fullSequence.indexOf(marker, searchStart);
                    if (idx !== -1 && idx > searchStart) {
                        markerEnd = idx;
                        break;
                    }
                }

                if (markerStart !== null && markerEnd !== null && markerStart < markerEnd) {
                    insertStart = markerStart;
                    insertEnd = markerEnd;
                }

                if (insertStart === null || insertEnd === null || insertStart >= insertEnd) {
                    throw new Error(`Could not find insert between ${config.startSite} and ${config.endSite} sites.`);
                }

                const insertSequence = fullSequence.substring(insertStart, insertEnd);

                // Parse and filter features
                const allFeatures = parseGenbankFeatures(fileContent);
                const insertFeatures = allFeatures
                    .filter(f => f.start >= insertStart && f.end <= insertEnd)
                    .map(f => ({
                        ...f,
                        originalStart: f.start,
                        originalEnd: f.end,
                        start: f.start - insertStart + 1,
                        end: f.end - insertStart + 1,
                        source: elementType
                    }));

                entryFeatures[elementType] = insertFeatures;

                return {
                    fullSequence: fullSequence,
                    insertSequence: insertSequence,
                    insertStart: insertStart,
                    insertEnd: insertEnd,
                    features: insertFeatures,
                    name: extractPlasmidName(fileContent)
                };
            } catch (error) {
                throw new Error(`Entry clone parsing error: ${error.message}`);
            }
        }

        // Set up file input handlers
        document.getElementById('fileDest').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        destVectorData = parseDestVector(e.target.result);
                        document.getElementById('infoDest').innerHTML =
                            `Loaded: ${destVectorData.name} (${destVectorData.fullSequence.length} bp total, ` +
                            `backbone: ${destVectorData.backbone5.length + destVectorData.backbone3.length} bp)`;
                        document.getElementById('errorDest').textContent = '';
                    } catch (error) {
                        document.getElementById('errorDest').textContent = error.message;
                        destVectorData = null;
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('file5').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const result = parseEntryClone(e.target.result, '5');
                        document.getElementById('seq5').value = result.insertSequence;
                        sequenceSources['5'] = 'entry';
                        document.getElementById('info5').innerHTML =
                            `Length: ${result.insertSequence.length} bp <span class="source-badge entry">Entry Clone</span>`;
                        document.getElementById('error5').textContent = '';
                    } catch (error) {
                        document.getElementById('error5').textContent = error.message;
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('fileMiddle').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const result = parseEntryClone(e.target.result, 'middle');
                        document.getElementById('seqMiddle').value = result.insertSequence;
                        sequenceSources['middle'] = 'entry';
                        document.getElementById('infoMiddle').innerHTML =
                            `Length: ${result.insertSequence.length} bp <span class="source-badge entry">Entry Clone</span>`;
                        document.getElementById('errorMiddle').textContent = '';
                    } catch (error) {
                        document.getElementById('errorMiddle').textContent = error.message;
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('file3').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const result = parseEntryClone(e.target.result, '3');
                        document.getElementById('seq3').value = result.insertSequence;
                        sequenceSources['3'] = 'entry';
                        document.getElementById('info3').innerHTML =
                            `Length: ${result.insertSequence.length} bp <span class="source-badge entry">Entry Clone</span>`;
                        document.getElementById('error3').textContent = '';
                    } catch (error) {
                        document.getElementById('error3').textContent = error.message;
                    }
                };
                reader.readAsText(file);
            }
        });

        // Update sequence info on manual input
        ['seq5', 'seqMiddle', 'seq3'].forEach(id => {
            document.getElementById(id).addEventListener('input', function(e) {
                const seq = cleanSequence(e.target.value);
                const elementKey = id === 'seq5' ? '5' : (id === 'seqMiddle' ? 'middle' : '3');
                if (e.target.value && sequenceSources[elementKey] !== 'entry') {
                    sequenceSources[elementKey] = 'raw';
                    document.getElementById('info' + (elementKey === '5' ? '5' : (elementKey === 'middle' ? 'Middle' : '3'))).innerHTML =
                        `Length: ${seq.length} bp <span class="source-badge raw">Raw Sequence</span>`;
                }
            });
        });

        function cleanSequence(seq) {
            return seq.replace(/[^ATCGatcg]/g, '').toUpperCase();
        }

        function reverseComplement(seq) {
            const complement = {'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C'};
            return seq.split('').reverse().map(base => complement[base] || base).join('');
        }

        function calculateTm(seq) {
            const a = (seq.match(/A/g) || []).length;
            const t = (seq.match(/T/g) || []).length;
            const g = (seq.match(/G/g) || []).length;
            const c = (seq.match(/C/g) || []).length;

            if (seq.length < 14) {
                return (a + t) * 2 + (g + c) * 4;
            } else {
                return Math.round(64.9 + 41 * (g + c - 16.4) / seq.length);
            }
        }

        function calculateFrameAdjustment(seq5, seqMiddle) {
            const attB1Length = attBRecombinedSequences.attB1.length;
            const totalBefore = seq5.length + attB1Length;
            const remainder = totalBefore % 3;

            if (remainder === 0) return '';
            const needed = 3 - remainder;
            return 'A'.repeat(needed);
        }

        function calculateFrame3Adjustment(seqMiddle, seq3) {
            const attB2Length = attBRecombinedSequences.attB2.length;
            const totalBefore = seqMiddle.length + attB2Length;
            const remainder = totalBefore % 3;

            if (remainder === 0) return '';
            const needed = 3 - remainder;
            return 'A'.repeat(needed);
        }

        function findLongestORF(sequence) {
            let longestORF = { start: 0, end: 0, length: 0 };

            for (let frame = 0; frame < 3; frame++) {
                let inORF = false;
                let orfStart = 0;

                for (let i = frame; i < sequence.length - 2; i += 3) {
                    const codon = sequence.substring(i, i + 3);

                    if (codon === 'ATG' && !inORF) {
                        inORF = true;
                        orfStart = i;
                    }

                    if (inORF && (codon === 'TAA' || codon === 'TAG' || codon === 'TGA')) {
                        const orfLength = i + 3 - orfStart;
                        if (orfLength > longestORF.length) {
                            longestORF = { start: orfStart, end: i + 3, length: orfLength, frame: frame };
                        }
                        inORF = false;
                    }
                }

                if (inORF) {
                    const orfLength = sequence.length - orfStart;
                    if (orfLength > longestORF.length) {
                        longestORF = { start: orfStart, end: sequence.length, length: orfLength, frame: frame };
                    }
                }
            }

            return longestORF;
        }

        function translateSequence(sequence) {
            let protein = '';
            for (let i = 0; i < sequence.length - 2; i += 3) {
                const codon = sequence.substring(i, i + 3);
                protein += codonTable[codon] || 'X';
            }
            return protein;
        }

        function assembleSequences() {
            const seq5 = cleanSequence(document.getElementById('seq5').value);
            const seqMiddle = cleanSequence(document.getElementById('seqMiddle').value);
            const seq3 = cleanSequence(document.getElementById('seq3').value);
            const frame5 = document.getElementById('frame5').checked;
            const frame3 = document.getElementById('frame3').checked;

            document.getElementById('error5').textContent = '';
            document.getElementById('errorMiddle').textContent = '';
            document.getElementById('error3').textContent = '';

            if (!seq5) {
                document.getElementById('error5').textContent = 'Please enter a 5\' element sequence';
                return;
            }
            if (!seqMiddle) {
                document.getElementById('errorMiddle').textContent = 'Please enter a middle element sequence';
                return;
            }
            if (!seq3) {
                document.getElementById('error3').textContent = 'Please enter a 3\' element sequence';
                return;
            }

            const frame5nt = frame5 ? calculateFrameAdjustment(seq5, seqMiddle) : '';
            const frame3nt = frame3 ? calculateFrame3Adjustment(seqMiddle, seq3) : '';

            // Build the full expression clone sequence
            let fullSequence = '';
            let positions = {};

            // Add backbone5 if available
            if (destVectorData) {
                positions.backbone5Start = 0;
                fullSequence += destVectorData.backbone5;
                positions.backbone5End = fullSequence.length;
            }

            // Add attB4
            positions.attB4Start = fullSequence.length;
            fullSequence += attBRecombinedSequences.attB4;
            positions.attB4End = fullSequence.length;

            // Add 5' element
            positions.element5Start = fullSequence.length;
            fullSequence += seq5;
            positions.element5End = fullSequence.length;

            // Add attB1
            positions.attB1Start = fullSequence.length;
            fullSequence += attBRecombinedSequences.attB1;
            positions.attB1End = fullSequence.length;

            // Add frame adjustment for 5' if needed
            if (frame5nt) {
                positions.frame5Start = fullSequence.length;
                fullSequence += frame5nt;
                positions.frame5End = fullSequence.length;
            }

            // Add middle element
            positions.middleStart = fullSequence.length;
            fullSequence += seqMiddle;
            positions.middleEnd = fullSequence.length;

            // Add attB2
            positions.attB2Start = fullSequence.length;
            fullSequence += attBRecombinedSequences.attB2;
            positions.attB2End = fullSequence.length;

            // Add frame adjustment for 3' if needed
            if (frame3nt) {
                positions.frame3Start = fullSequence.length;
                fullSequence += frame3nt;
                positions.frame3End = fullSequence.length;
            }

            // Add 3' element
            positions.element3Start = fullSequence.length;
            fullSequence += seq3;
            positions.element3End = fullSequence.length;

            // Add attB3
            positions.attB3Start = fullSequence.length;
            fullSequence += attBRecombinedSequences.attB3;
            positions.attB3End = fullSequence.length;

            // Add backbone3 if available
            if (destVectorData) {
                positions.backbone3Start = fullSequence.length;
                fullSequence += destVectorData.backbone3;
                positions.backbone3End = fullSequence.length;
            }

            // Build inserted sequence (without backbone)
            let insertSequence = attBRecombinedSequences.attB4 + seq5 +
                                 attBRecombinedSequences.attB1 + frame5nt + seqMiddle +
                                 attBRecombinedSequences.attB2 + frame3nt + seq3 +
                                 attBRecombinedSequences.attB3;

            // Find longest ORF in middle element
            const middleORF = findLongestORF(seqMiddle);

            // Generate primers for raw sequences
            const primers = generatePrimers(seq5, seqMiddle, seq3, frame5nt, frame3nt, frame5, frame3);

            // Assemble features from all sources
            let assembledFeatures = [];

            // Add backbone5 features
            if (destVectorData && destVectorData.backbone5Features) {
                destVectorData.backbone5Features.forEach(f => {
                    assembledFeatures.push({
                        ...f,
                        adjustedStart: f.start,
                        adjustedEnd: f.end
                    });
                });
            }

            // Add 5' element features
            if (entryFeatures['5']) {
                entryFeatures['5'].forEach(f => {
                    assembledFeatures.push({
                        ...f,
                        adjustedStart: positions.element5Start + f.start,
                        adjustedEnd: positions.element5Start + f.end
                    });
                });
            }

            // Add middle element features
            if (entryFeatures['middle']) {
                entryFeatures['middle'].forEach(f => {
                    assembledFeatures.push({
                        ...f,
                        adjustedStart: positions.middleStart + f.start,
                        adjustedEnd: positions.middleStart + f.end
                    });
                });
            }

            // Add 3' element features
            if (entryFeatures['3']) {
                entryFeatures['3'].forEach(f => {
                    assembledFeatures.push({
                        ...f,
                        adjustedStart: positions.element3Start + f.start,
                        adjustedEnd: positions.element3Start + f.end
                    });
                });
            }

            // Add backbone3 features
            if (destVectorData && destVectorData.backbone3Features) {
                destVectorData.backbone3Features.forEach(f => {
                    assembledFeatures.push({
                        ...f,
                        adjustedStart: positions.backbone3Start + f.start,
                        adjustedEnd: positions.backbone3Start + f.end
                    });
                });
            }

            // Store assembled data
            assembledData = {
                fullSequence,
                insertSequence,
                seq5,
                seqMiddle,
                seq3,
                frame5,
                frame3,
                frame5nt,
                frame3nt,
                primers,
                sources: {...sequenceSources},
                middleORF,
                hasBackbone: !!destVectorData,
                destName: destVectorData ? destVectorData.name : null,
                positions,
                features: assembledFeatures
            };

            // Display results
            displayWorkflow();
            displayAssembly();
            displayTranslation();
            displayPrimers();
            displayStats();
            drawVectorMap();
        }

        function generatePrimers(seq5, seqMiddle, seq3, frame5nt, frame3nt, useFrame5, useFrame3) {
            const primerBindingLength = 18;
            const primers = [];

            if (sequenceSources['5'] === 'raw') {
                const geneSpecific5F = seq5.substring(0, Math.min(primerBindingLength, seq5.length));
                primers.push({
                    name: "5' Element Forward (attB4)",
                    attb: attBPrimerSequences.attB4,
                    frame: '',
                    geneSpecific: geneSpecific5F,
                    fullSequence: attBPrimerSequences.attB4 + geneSpecific5F,
                    tm: calculateTm(geneSpecific5F),
                    description: "For BP reaction with pDONR P4-P1R",
                    pdonr: "pDONR P4-P1R"
                });

                const geneSpecific5R = reverseComplement(seq5.substring(Math.max(0, seq5.length - primerBindingLength)));
                primers.push({
                    name: "5' Element Reverse (attB1r)",
                    attb: attBPrimerSequences.attB1r,
                    frame: '',
                    geneSpecific: geneSpecific5R,
                    fullSequence: attBPrimerSequences.attB1r + geneSpecific5R,
                    tm: calculateTm(geneSpecific5R),
                    description: "For BP reaction with pDONR P4-P1R",
                    pdonr: "pDONR P4-P1R"
                });
            }

            if (sequenceSources['middle'] === 'raw') {
                const frameNt = useFrame5 ? frame5nt : '';
                const geneSpecificMF = seqMiddle.substring(0, Math.min(primerBindingLength, seqMiddle.length));
                primers.push({
                    name: "Middle Element Forward (attB1)",
                    attb: attBPrimerSequences.attB1,
                    frame: frameNt,
                    geneSpecific: geneSpecificMF,
                    fullSequence: attBPrimerSequences.attB1 + frameNt + geneSpecificMF,
                    tm: calculateTm(geneSpecificMF),
                    description: "For BP reaction with pDONR 221" + (frameNt ? ` (includes ${frameNt.length} nt frame adjustment)` : ''),
                    pdonr: "pDONR 221"
                });

                const geneSpecificMR = reverseComplement(seqMiddle.substring(Math.max(0, seqMiddle.length - primerBindingLength)));
                primers.push({
                    name: "Middle Element Reverse (attB2)",
                    attb: attBPrimerSequences.attB2,
                    frame: '',
                    geneSpecific: geneSpecificMR,
                    fullSequence: attBPrimerSequences.attB2 + geneSpecificMR,
                    tm: calculateTm(geneSpecificMR),
                    description: "For BP reaction with pDONR 221",
                    pdonr: "pDONR 221"
                });
            }

            if (sequenceSources['3'] === 'raw') {
                const frameNt = useFrame3 ? frame3nt : '';
                const geneSpecific3F = seq3.substring(0, Math.min(primerBindingLength, seq3.length));
                primers.push({
                    name: "3' Element Forward (attB2r)",
                    attb: attBPrimerSequences.attB2r,
                    frame: frameNt,
                    geneSpecific: geneSpecific3F,
                    fullSequence: attBPrimerSequences.attB2r + frameNt + geneSpecific3F,
                    tm: calculateTm(geneSpecific3F),
                    description: "For BP reaction with pDONR P2R-P3" + (frameNt ? ` (includes ${frameNt.length} nt frame adjustment)` : ''),
                    pdonr: "pDONR P2R-P3"
                });

                const geneSpecific3R = reverseComplement(seq3.substring(Math.max(0, seq3.length - primerBindingLength)));
                primers.push({
                    name: "3' Element Reverse (attB3)",
                    attb: attBPrimerSequences.attB3,
                    frame: '',
                    geneSpecific: geneSpecific3R,
                    fullSequence: attBPrimerSequences.attB3 + geneSpecific3R,
                    tm: calculateTm(geneSpecific3R),
                    description: "For BP reaction with pDONR P2R-P3",
                    pdonr: "pDONR P2R-P3"
                });
            }

            return primers;
        }

        function displayWorkflow() {
            const display = document.getElementById('workflowDisplay');
            const data = assembledData;

            let html = '<div style="font-size: 1em;">';

            html += '<div style="margin-bottom: 15px;">';
            html += '<strong>Step 1: BP Reactions (create Entry clones)</strong>';

            if (data.sources['5'] === 'raw') {
                html += '<div class="workflow-step bp-reaction">';
                html += `<span style="color: #4A90E2; font-weight: bold;">5' Element:</span>&nbsp;`;
                html += `attB4-PCR product-attB1r + pDONR P4-P1R -> Entry clone`;
                html += '</div>';
            } else {
                html += '<div class="workflow-step" style="background: #e3f2fd; border-left: 3px solid #2196f3;">';
                html += `<span style="color: #4A90E2; font-weight: bold;">5' Element:</span>&nbsp;Using uploaded Entry clone`;
                html += '</div>';
            }

            if (data.sources['middle'] === 'raw') {
                html += '<div class="workflow-step bp-reaction">';
                html += `<span style="color: #7ED321; font-weight: bold;">Middle Element:</span>&nbsp;`;
                html += `attB1-PCR product-attB2 + pDONR 221 -> Entry clone`;
                html += '</div>';
            } else {
                html += '<div class="workflow-step" style="background: #e8f5e9; border-left: 3px solid #4caf50;">';
                html += `<span style="color: #7ED321; font-weight: bold;">Middle Element:</span>&nbsp;Using uploaded Entry clone`;
                html += '</div>';
            }

            if (data.sources['3'] === 'raw') {
                html += '<div class="workflow-step bp-reaction">';
                html += `<span style="color: #F5A623; font-weight: bold;">3' Element:</span>&nbsp;`;
                html += `attB2r-PCR product-attB3 + pDONR P2R-P3 -> Entry clone`;
                html += '</div>';
            } else {
                html += '<div class="workflow-step" style="background: #fff3e0; border-left: 3px solid #ff9800;">';
                html += `<span style="color: #F5A623; font-weight: bold;">3' Element:</span>&nbsp;Using uploaded Entry clone`;
                html += '</div>';
            }

            html += '</div>';

            html += '<div class="workflow-arrow">v</div>';

            html += '<div style="margin-bottom: 15px;">';
            html += '<strong>Step 2: LR Reaction (create Expression clone)</strong>';
            html += '<div class="workflow-step lr-reaction">';
            if (data.hasBackbone) {
                html += `3 Entry clones + ${data.destName} -> Expression clone`;
            } else {
                html += `3 Entry clones + pDEST -> Expression clone (no backbone loaded)`;
            }
            html += '</div>';
            html += '</div>';

            html += '<div class="workflow-arrow">v</div>';

            html += '<div>';
            html += '<strong>Final Expression Clone Structure:</strong>';
            html += '<div style="margin-top: 8px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 1em;">';
            if (data.hasBackbone) {
                html += '<span style="background: #e1bee7; padding: 2px 4px;">5\' backbone</span>';
            }
            html += '<span style="background: #ffcdd2; padding: 2px 4px;">attB4</span>';
            html += '<span style="background: #bbdefb; padding: 2px 4px;">5\' element</span>';
            html += '<span style="background: #f8bbd9; padding: 2px 4px;">attB1</span>';
            if (data.frame5 && data.frame5nt) {
                html += '<span style="background: #b2dfdb; padding: 2px 4px;">+' + data.frame5nt.length + 'nt</span>';
            }
            html += '<span style="background: #c8e6c9; padding: 2px 4px;">Middle</span>';
            html += '<span style="background: #ffe0b2; padding: 2px 4px;">attB2</span>';
            if (data.frame3 && data.frame3nt) {
                html += '<span style="background: #b2dfdb; padding: 2px 4px;">+' + data.frame3nt.length + 'nt</span>';
            }
            html += '<span style="background: #fff9c4; padding: 2px 4px;">3\' element</span>';
            html += '<span style="background: #d1c4e9; padding: 2px 4px;">attB3</span>';
            if (data.hasBackbone) {
                html += '<span style="background: #e1bee7; padding: 2px 4px;">3\' backbone</span>';
            }
            html += '</div>';
            html += '</div>';

            html += '</div>';
            display.innerHTML = html;
        }

        function displayAssembly() {
            const display = document.getElementById('assemblyDisplay');
            const data = assembledData;

            let html = '';
            const pos = data.positions;

            if (data.hasBackbone && pos.backbone5End > pos.backbone5Start) {
                html += `<span class="seq-backbone">${data.fullSequence.substring(pos.backbone5Start, pos.backbone5End)}</span>`;
            }

            html += `<span class="seq-attb4">${data.fullSequence.substring(pos.attB4Start, pos.attB4End)}</span>`;
            html += `<span class="seq-5element">${data.fullSequence.substring(pos.element5Start, pos.element5End)}</span>`;
            html += `<span class="seq-attb1">${data.fullSequence.substring(pos.attB1Start, pos.attB1End)}</span>`;

            if (data.frame5nt && pos.frame5End > pos.frame5Start) {
                html += `<span class="seq-frame">${data.fullSequence.substring(pos.frame5Start, pos.frame5End)}</span>`;
            }

            html += `<span class="seq-middle">${data.fullSequence.substring(pos.middleStart, pos.middleEnd)}</span>`;
            html += `<span class="seq-attb2">${data.fullSequence.substring(pos.attB2Start, pos.attB2End)}</span>`;

            if (data.frame3nt && pos.frame3End > pos.frame3Start) {
                html += `<span class="seq-frame">${data.fullSequence.substring(pos.frame3Start, pos.frame3End)}</span>`;
            }

            html += `<span class="seq-3element">${data.fullSequence.substring(pos.element3Start, pos.element3End)}</span>`;
            html += `<span class="seq-attb3">${data.fullSequence.substring(pos.attB3Start, pos.attB3End)}</span>`;

            if (data.hasBackbone && pos.backbone3End > pos.backbone3Start) {
                html += `<span class="seq-backbone">${data.fullSequence.substring(pos.backbone3Start, pos.backbone3End)}</span>`;
            }

            display.innerHTML = html;
        }

        function displayTranslation() {
            const display = document.getElementById('translationDisplay');
            const data = assembledData;

            if (!data.middleORF || data.middleORF.length === 0) {
                display.innerHTML = '<p style="color: #999;">No ORF found in middle element</p>';
                return;
            }

            const orf = data.middleORF;
            const orfSeq = data.seqMiddle.substring(orf.start, orf.end);
            const protein = translateSequence(orfSeq);

            let html = '<div class="translation-frame">';
            html += `<div class="frame-label">Longest ORF (Frame +${orf.frame + 1}): ${orf.length} bp, ${protein.length} aa</div>`;
            html += '<div class="protein-seq">';

            for (let i = 0; i < protein.length; i++) {
                const aa = protein[i];
                if (aa === 'M' && i === 0) {
                    html += `<span class="start-codon">${aa}</span>`;
                } else if (aa === '*') {
                    html += `<span class="stop-codon">${aa}</span>`;
                } else {
                    html += `<span class="aa-from-middle">${aa}</span>`;
                }
            }

            html += '</div></div>';
            display.innerHTML = html;
        }

        function displayPrimers() {
            const display = document.getElementById('primerDisplay');
            const data = assembledData;

            if (data.primers.length === 0) {
                display.innerHTML = '<p style="color: #999; text-align: center;">All elements from Entry clones - no BP primers needed</p>';
                return;
            }

            let html = '';

            const primersByDonor = {};
            data.primers.forEach(primer => {
                if (!primersByDonor[primer.pdonr]) {
                    primersByDonor[primer.pdonr] = [];
                }
                primersByDonor[primer.pdonr].push(primer);
            });

            for (const donorType of Object.keys(primersByDonor)) {
                html += `<div class="primer-section">`;
                html += `<div class="primer-section-title">${donorType}</div>`;

                primersByDonor[donorType].forEach(primer => {
                    html += '<div class="primer-item">';
                    html += `<div class="primer-name">${primer.name}</div>`;
                    html += `<div class="primer-seq">`;
                    html += `<span class="primer-attb">${primer.attb}</span>`;
                    if (primer.frame) {
                        html += `<span style="color: #00897b; font-weight: bold;">${primer.frame}</span>`;
                    }
                    html += `<span class="primer-gene">${primer.geneSpecific}</span>`;
                    html += `</div>`;
                    html += `<div class="primer-info">Length: ${primer.fullSequence.length} bp | Gene-specific Tm: ~${primer.tm}C</div>`;
                    html += '</div>';
                });

                html += '</div>';
            }

            display.innerHTML = html;
        }

        function displayStats() {
            const data = assembledData;
            const seq = data.fullSequence;

            const gc = (seq.match(/[GC]/g) || []).length / seq.length * 100;
            const mw = seq.length * 660;

            document.getElementById('statSize').textContent = seq.length.toLocaleString() + ' bp';
            document.getElementById('statGC').textContent = gc.toFixed(1) + '%';
            document.getElementById('statMW').textContent = (mw / 1000).toFixed(1) + ' kDa';
        }

        function drawVectorMap() {
            const svg = document.getElementById('vectorMap');
            const data = assembledData;

            const width = 400;
            const height = 400;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = 150;

            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            let svgContent = '';

            // Draw circle
            svgContent += `<circle cx="${centerX}" cy="${centerY}" r="${radius}" fill="none" stroke="#ddd" stroke-width="20"/>`;

            const totalLength = data.fullSequence.length;
            const pos = data.positions;

            function drawArc(startPos, endPos, color, label) {
                const startAngle = (startPos / totalLength) * 2 * Math.PI - Math.PI / 2;
                const endAngle = (endPos / totalLength) * 2 * Math.PI - Math.PI / 2;

                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);

                const largeArc = (endAngle - startAngle) > Math.PI ? 1 : 0;

                svgContent += `<path d="M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}"
                    fill="none" stroke="${color}" stroke-width="18" stroke-linecap="butt"/>`;

                const midAngle = (startAngle + endAngle) / 2;
                const labelRadius = radius + 35;
                const labelX = centerX + labelRadius * Math.cos(midAngle);
                const labelY = centerY + labelRadius * Math.sin(midAngle);

                if (endPos - startPos > totalLength * 0.02) {
                    svgContent += `<text x="${labelX}" y="${labelY}" text-anchor="middle"
                        dominant-baseline="middle" font-size="10" fill="#333">${label}</text>`;
                }
            }

            // Draw segments
            if (data.hasBackbone) {
                drawArc(pos.backbone5Start, pos.backbone5End, '#e1bee7', "5' backbone");
            }
            drawArc(pos.attB4Start, pos.attB4End, '#ffcdd2', 'attB4');
            drawArc(pos.element5Start, pos.element5End, '#bbdefb', "5' element");
            drawArc(pos.attB1Start, pos.attB1End, '#f8bbd9', 'attB1');
            drawArc(pos.middleStart, pos.middleEnd, '#c8e6c9', 'Middle');
            drawArc(pos.attB2Start, pos.attB2End, '#ffe0b2', 'attB2');
            drawArc(pos.element3Start, pos.element3End, '#fff9c4', "3' element");
            drawArc(pos.attB3Start, pos.attB3End, '#d1c4e9', 'attB3');
            if (data.hasBackbone) {
                drawArc(pos.backbone3Start, pos.backbone3End, '#e1bee7', "3' backbone");
            }

            // Center text
            svgContent += `<text x="${centerX}" y="${centerY - 10}" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">Expression Clone</text>`;
            svgContent += `<text x="${centerX}" y="${centerY + 10}" text-anchor="middle" font-size="12" fill="#666">${totalLength.toLocaleString()} bp</text>`;

            svg.innerHTML = svgContent;
        }

        function exportFASTA() {
            if (!assembledData) {
                alert('Please generate an assembly first');
                return;
            }

            const header = '>Expression_Clone_' + assembledData.fullSequence.length + 'bp';
            const seq = assembledData.fullSequence.match(/.{1,80}/g).join('\n');
            const content = header + '\n' + seq;

            downloadFile('expression_clone.fasta', content);
        }

        function exportGenBank() {
            if (!assembledData) {
                alert('Please generate an assembly first');
                return;
            }

            const data = assembledData;
            const seq = data.fullSequence;
            const pos = data.positions;
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '-');

            let gb = '';
            gb += `LOCUS       Expression_Clone    ${seq.length} bp    DNA     circular SYN ${dateStr}\n`;
            gb += `DEFINITION  MultiSite Gateway Expression Clone\n`;
            gb += `ACCESSION   .\n`;
            gb += `KEYWORDS    .\n`;
            gb += `SOURCE      synthetic construct\n`;
            gb += `  ORGANISM  synthetic construct\n`;
            gb += `FEATURES             Location/Qualifiers\n`;

            // Add basic structural annotations first
            if (data.hasBackbone && pos.backbone5End > pos.backbone5Start) {
                gb += `     misc_feature    ${pos.backbone5Start + 1}..${pos.backbone5End}\n`;
                gb += `                     /label="5' backbone"\n`;
            }
            gb += `     misc_feature    ${pos.attB4Start + 1}..${pos.attB4End}\n`;
            gb += `                     /label="attB4"\n`;
            gb += `     misc_feature    ${pos.element5Start + 1}..${pos.element5End}\n`;
            gb += `                     /label="5' element"\n`;
            gb += `     misc_feature    ${pos.attB1Start + 1}..${pos.attB1End}\n`;
            gb += `                     /label="attB1"\n`;
            if (data.frame5nt && pos.frame5End > pos.frame5Start) {
                gb += `     misc_feature    ${pos.frame5Start + 1}..${pos.frame5End}\n`;
                gb += `                     /label="frame adjustment"\n`;
            }
            gb += `     misc_feature    ${pos.middleStart + 1}..${pos.middleEnd}\n`;
            gb += `                     /label="middle element"\n`;
            gb += `     misc_feature    ${pos.attB2Start + 1}..${pos.attB2End}\n`;
            gb += `                     /label="attB2"\n`;
            if (data.frame3nt && pos.frame3End > pos.frame3Start) {
                gb += `     misc_feature    ${pos.frame3Start + 1}..${pos.frame3End}\n`;
                gb += `                     /label="frame adjustment"\n`;
            }
            gb += `     misc_feature    ${pos.element3Start + 1}..${pos.element3End}\n`;
            gb += `                     /label="3' element"\n`;
            gb += `     misc_feature    ${pos.attB3Start + 1}..${pos.attB3End}\n`;
            gb += `                     /label="attB3"\n`;
            if (data.hasBackbone && pos.backbone3End > pos.backbone3Start) {
                gb += `     misc_feature    ${pos.backbone3Start + 1}..${pos.backbone3End}\n`;
                gb += `                     /label="3' backbone"\n`;
            }

            // Add carried-over features from uploaded files
            if (data.features && data.features.length > 0) {
                data.features.forEach(f => {
                    if (f.adjustedStart && f.adjustedEnd) {
                        const locationStr = f.complement ?
                            `complement(${f.adjustedStart}..${f.adjustedEnd})` :
                            `${f.adjustedStart}..${f.adjustedEnd}`;

                        gb += `     ${f.type.padEnd(16)}${locationStr}\n`;

                        if (f.qualifiers) {
                            if (f.qualifiers.label) {
                                gb += `                     /label="${f.qualifiers.label}"\n`;
                            }
                            if (f.qualifiers.note) {
                                gb += `                     /note="${f.qualifiers.note}"\n`;
                            }
                            if (f.qualifiers.product) {
                                gb += `                     /product="${f.qualifiers.product}"\n`;
                            }
                        }
                    }
                });
            }

            gb += `ORIGIN\n`;

            for (let i = 0; i < seq.length; i += 60) {
                const lineNum = (i + 1).toString().padStart(9, ' ');
                const chunk = seq.substring(i, i + 60).toLowerCase();
                const formatted = chunk.match(/.{1,10}/g).join(' ');
                gb += `${lineNum} ${formatted}\n`;
            }

            gb += `//\n`;

            downloadFile('expression_clone.gb', gb);
        }

        function exportPrimers() {
            if (!assembledData || assembledData.primers.length === 0) {
                alert('No primers to export');
                return;
            }

            let csv = 'Name,Sequence,Length,Gene-specific Tm,Description\n';

            assembledData.primers.forEach(primer => {
                csv += `"${primer.name}","${primer.fullSequence}",${primer.fullSequence.length},${primer.tm},"${primer.description}"\n`;
            });

            downloadFile('gateway_primers.csv', csv);
        }

        function exportReport() {
            if (!assembledData) {
                alert('Please generate an assembly first');
                return;
            }

            const data = assembledData;
            const seq = data.fullSequence;
            const gc = (seq.match(/[GC]/g) || []).length / seq.length * 100;
            const gcPercent = gc.toFixed(1);

            let report = '';
            report += '='.repeat(60) + '\n';
            report += 'MULTISITE GATEWAY CLONING REPORT\n';
            report += '='.repeat(60) + '\n\n';

            report += 'ELEMENT SOURCES\n';
            report += '-'.repeat(60) + '\n';
            report += `5' Element: ${data.sources['5'] === 'entry' ? 'Entry Clone' : 'Raw Sequence'} (${data.seq5.length} bp)\n`;
            report += `Middle Element: ${data.sources['middle'] === 'entry' ? 'Entry Clone' : 'Raw Sequence'} (${data.seqMiddle.length} bp)\n`;
            report += `3' Element: ${data.sources['3'] === 'entry' ? 'Entry Clone' : 'Raw Sequence'} (${data.seq3.length} bp)\n`;
            if (data.hasBackbone) {
                report += `Destination Vector: ${data.destName}\n`;
            }
            report += '\n';

            report += 'FRAME ADJUSTMENTS\n';
            report += '-'.repeat(60) + '\n';
            report += `5' in frame with middle: ${data.frame5 ? 'Yes' : 'No'}`;
            if (data.frame5 && data.frame5nt) report += ` (+${data.frame5nt.length} nt: ${data.frame5nt})`;
            report += '\n';
            report += `3' in frame with middle: ${data.frame3 ? 'Yes' : 'No'}`;
            if (data.frame3 && data.frame3nt) report += ` (+${data.frame3nt.length} nt: ${data.frame3nt})`;
            report += '\n\n';

            report += 'ASSEMBLY STATISTICS\n';
            report += '-'.repeat(60) + '\n';
            report += `Total Size: ${seq.length} bp\n`;
            report += `Insert Size: ${data.insertSequence.length} bp\n`;
            report += `GC Content: ${gcPercent}%\n\n`;

            if (data.primers.length > 0) {
                report += 'PCR PRIMERS\n';
                report += '-'.repeat(60) + '\n';
                data.primers.forEach(primer => {
                    report += `\n${primer.name}\n`;
                    report += `  ${primer.fullSequence}\n`;
                    report += `  Length: ${primer.fullSequence.length} bp | Tm: ~${primer.tm}C\n`;
                });
            }

            report += '\n\nFULL SEQUENCE\n';
            report += '-'.repeat(60) + '\n';
            report += seq + '\n';

            downloadFile('multisite_gateway_report.txt', report);
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========== VECTOR VIEWER FUNCTIONS ==========
        let currentViewerVector = null;
        let viewerFeatures = [];
        let vectorList = [];

        // Feature colors for visualization
        const featureColors = {
            'CDS': '#81c784',
            'gene': '#64b5f6',
            'promoter': '#fff176',
            'terminator': '#ef9a9a',
            'misc_feature': '#ce93d8',
            'protein_bind': '#80cbc4',
            'rep_origin': '#ffcc80',
            'primer_bind': '#e0e0e0',
            'polyA_signal': '#f48fb1',
            'regulatory': '#a5d6a7',
            'source': '#b0bec5',
            'default': '#b0bec5'
        };

        // Load vector list on page load
        async function loadVectorList() {
            try {
                const response = await fetch('Gateway_vectors/vectors.json');
                if (!response.ok) throw new Error('Could not load vector list');
                const data = await response.json();
                vectorList = data.vectors;
                populateVectorDropdown();
            } catch (error) {
                console.log('Vector list not available:', error.message);
                document.getElementById('vectorLoadStatus').innerHTML =
                    '<span style="color: #666; font-size: 0.9em;">Vector library not available - use file upload</span>';
            }
        }

        function populateVectorDropdown() {
            const select = document.getElementById('vectorSelect');
            select.innerHTML = '<option value="">-- Choose a vector --</option>';

            // Group by type
            const types = ['Destination', '5\' Entry', 'Middle Entry', '3\' Entry', 'Other'];
            types.forEach(type => {
                const vectors = vectorList.filter(v => v.type === type);
                if (vectors.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = type;
                    vectors.forEach(v => {
                        const option = document.createElement('option');
                        option.value = v.file;
                        option.textContent = v.name;
                        option.title = v.description;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }
            });
        }

        async function loadSelectedVector() {
            const select = document.getElementById('vectorSelect');
            const filename = select.value;
            if (!filename) {
                hideViewerContent();
                return;
            }

            document.getElementById('vectorLoadStatus').innerHTML = '<span style="color: #9d7f37;">Loading...</span>';

            try {
                const response = await fetch('Gateway_vectors/' + encodeURIComponent(filename));
                if (!response.ok) throw new Error('Could not load vector file');
                const content = await response.text();

                const vectorInfo = vectorList.find(v => v.file === filename);
                parseAndDisplayVector(content, vectorInfo);
                document.getElementById('vectorLoadStatus').innerHTML = '';
            } catch (error) {
                document.getElementById('vectorLoadStatus').innerHTML =
                    '<span style="color: #d32f2f;">Error: ' + error.message + '</span>';
            }
        }

        function loadUploadedVector(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('vectorLoadStatus').innerHTML = '<span style="color: #9d7f37;">Loading...</span>';
            document.getElementById('vectorSelect').value = '';

            const reader = new FileReader();
            reader.onload = function(e) {
                const vectorInfo = { name: file.name.replace(/\.(gb|gbk)$/i, ''), type: 'Uploaded', description: '' };
                parseAndDisplayVector(e.target.result, vectorInfo);
                document.getElementById('vectorLoadStatus').innerHTML = '';
            };
            reader.onerror = function() {
                document.getElementById('vectorLoadStatus').innerHTML =
                    '<span style="color: #d32f2f;">Error reading file</span>';
            };
            reader.readAsText(file);
        }

        function parseAndDisplayVector(content, vectorInfo) {
            try {
                // Parse sequence
                const originMatch = content.match(/ORIGIN\s+([\s\S]+?)\/\//);
                if (!originMatch) throw new Error('No sequence found in file');

                const sequence = originMatch[1]
                    .replace(/\d+/g, '')
                    .replace(/\s+/g, '')
                    .toUpperCase();

                // Parse LOCUS line for name and size
                const locusMatch = content.match(/LOCUS\s+(\S+)\s+(\d+)\s+bp/);
                const name = locusMatch ? locusMatch[1] : vectorInfo.name;
                const size = sequence.length;

                // Parse features
                viewerFeatures = parseViewerFeatures(content);

                // Calculate GC content
                const gc = ((sequence.match(/[GC]/g) || []).length / sequence.length * 100).toFixed(1);

                // Store current vector
                currentViewerVector = {
                    name: name,
                    size: size,
                    sequence: sequence,
                    type: vectorInfo.type,
                    gc: gc,
                    features: viewerFeatures
                };

                // Update display
                showViewerContent();
                updateVectorInfo();
                drawCircularMapViewer();
                updateLinearView();
                document.getElementById('seqEnd').value = Math.min(500, size);
                document.getElementById('seqEnd').max = size;
                document.getElementById('seqStart').max = size;
                document.getElementById('gotoPosition').max = size;
                updateSequenceView();
                updateFeatureList();

            } catch (error) {
                document.getElementById('vectorLoadStatus').innerHTML =
                    '<span style="color: #d32f2f;">Parse error: ' + error.message + '</span>';
            }
        }

        function parseViewerFeatures(content) {
            const features = [];
            const featuresMatch = content.match(/FEATURES\s+Location\/Qualifiers([\s\S]*?)(?=ORIGIN)/);
            if (!featuresMatch) return features;

            const lines = featuresMatch[1].split('\n');
            let currentFeature = null;
            let currentQualifiers = '';

            for (const line of lines) {
                const featureMatch = line.match(/^\s{5}(\S+)\s+((?:complement\()?(?:join\()?[\d.<>,]+\)?)/);

                if (featureMatch) {
                    if (currentFeature) {
                        currentFeature.qualifiers = parseViewerQualifiers(currentQualifiers);
                        features.push(currentFeature);
                    }

                    const type = featureMatch[1];
                    const locationStr = featureMatch[2];
                    const location = parseViewerLocation(locationStr);

                    currentFeature = {
                        type: type,
                        ...location,
                        color: featureColors[type] || featureColors.default,
                        qualifiers: {}
                    };
                    currentQualifiers = '';
                } else if (currentFeature && line.match(/^\s{21}/)) {
                    currentQualifiers += line.trim() + '\n';
                }
            }

            if (currentFeature) {
                currentFeature.qualifiers = parseViewerQualifiers(currentQualifiers);
                features.push(currentFeature);
            }

            return features;
        }

        function parseViewerLocation(locationStr) {
            let complement = false;
            let start = 0, end = 0;

            let workStr = locationStr;
            if (workStr.startsWith('complement(')) {
                complement = true;
                workStr = workStr.replace(/^complement\(/, '').replace(/\)$/, '');
            }
            if (workStr.startsWith('join(')) {
                workStr = workStr.replace(/^join\(/, '').replace(/\)$/, '');
            }

            const positions = workStr.match(/(\d+)/g);
            if (positions && positions.length >= 2) {
                start = parseInt(positions[0]);
                end = parseInt(positions[positions.length - 1]);
            } else if (positions) {
                start = end = parseInt(positions[0]);
            }

            return { start, end, complement };
        }

        function parseViewerQualifiers(text) {
            const qualifiers = {};
            let currentKey = null;
            let currentValue = '';

            for (const line of text.split('\n')) {
                if (!line.trim()) continue;
                const match = line.match(/^\/(\w+)(?:=(.*))?$/);
                if (match) {
                    if (currentKey) {
                        qualifiers[currentKey] = currentValue.replace(/^"/, '').replace(/"$/, '');
                    }
                    currentKey = match[1];
                    currentValue = match[2] || 'true';
                } else if (currentKey) {
                    currentValue += line;
                }
            }
            if (currentKey) {
                qualifiers[currentKey] = currentValue.replace(/^"/, '').replace(/"$/, '');
            }
            return qualifiers;
        }

        function showViewerContent() {
            document.getElementById('viewerContent').style.display = 'block';
            document.getElementById('viewerPlaceholder').style.display = 'none';
        }

        function hideViewerContent() {
            document.getElementById('viewerContent').style.display = 'none';
            document.getElementById('viewerPlaceholder').style.display = 'block';
            currentViewerVector = null;
        }

        function updateVectorInfo() {
            document.getElementById('viewerVectorName').textContent = currentViewerVector.name;
            document.getElementById('viewerVectorSize').textContent = currentViewerVector.size.toLocaleString() + ' bp';
            document.getElementById('viewerVectorType').textContent = currentViewerVector.type;
            document.getElementById('viewerGC').textContent = currentViewerVector.gc + '%';
        }

        function updateFeatureList() {
            const list = document.getElementById('featureList');
            const count = document.getElementById('featureCount');

            // Filter out source features and primer_bind for cleaner display
            const displayFeatures = viewerFeatures.filter(f =>
                f.type !== 'source' && f.type !== 'primer_bind'
            );

            count.textContent = displayFeatures.length;

            if (displayFeatures.length === 0) {
                list.innerHTML = '<div class="no-vector-message">No features found</div>';
                return;
            }

            list.innerHTML = displayFeatures.map((f, i) => {
                const label = f.qualifiers.label || f.qualifiers.gene || f.qualifiers.product || f.qualifiers.note || f.type;
                const direction = f.complement ? '(complement)' : '';
                return `
                    <div class="feature-item" onclick="highlightFeature(${i})" title="${f.qualifiers.note || ''}">
                        <span class="feature-type ${f.type}">${f.type}</span>
                        <span class="feature-name">${label}</span>
                        <div class="feature-location">${f.start}..${f.end} ${direction}</div>
                    </div>
                `;
            }).join('');
        }

        function highlightFeature(index) {
            const displayFeatures = viewerFeatures.filter(f =>
                f.type !== 'source' && f.type !== 'primer_bind'
            );
            const feature = displayFeatures[index];
            if (!feature) return;

            // Update sequence view to show this feature
            document.getElementById('seqStart').value = Math.max(1, feature.start - 50);
            document.getElementById('seqEnd').value = Math.min(currentViewerVector.size, feature.end + 50);
            updateSequenceView();

            // Scroll linear view to feature
            const zoom = parseInt(document.getElementById('linearZoom').value);
            const scrollContainer = document.getElementById('linearViewScroll');
            const pixelsPerBp = zoom;
            scrollContainer.scrollLeft = (feature.start - 100) * pixelsPerBp;
        }

        function drawCircularMapViewer() {
            const svg = document.getElementById('circularMap');
            const width = 360;
            const height = 360;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = 130;

            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            let svgContent = '';

            // Draw backbone circle
            svgContent += `<circle cx="${centerX}" cy="${centerY}" r="${radius}" fill="none" stroke="#ddd" stroke-width="25"/>`;

            // Draw features
            const totalLength = currentViewerVector.size;
            const displayFeatures = viewerFeatures.filter(f =>
                f.type !== 'source' && f.type !== 'primer_bind'
            );

            displayFeatures.forEach(feature => {
                const startAngle = (feature.start / totalLength) * 2 * Math.PI - Math.PI / 2;
                const endAngle = (feature.end / totalLength) * 2 * Math.PI - Math.PI / 2;

                // Only draw if the arc is significant
                if (endAngle - startAngle > 0.01) {
                    const x1 = centerX + radius * Math.cos(startAngle);
                    const y1 = centerY + radius * Math.sin(startAngle);
                    const x2 = centerX + radius * Math.cos(endAngle);
                    const y2 = centerY + radius * Math.sin(endAngle);
                    const largeArc = (endAngle - startAngle) > Math.PI ? 1 : 0;

                    const label = feature.qualifiers.label || feature.qualifiers.gene || feature.type;

                    svgContent += `<path d="M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}"
                        fill="none" stroke="${feature.color}" stroke-width="22" stroke-linecap="butt">
                        <title>${label}: ${feature.start}..${feature.end}</title>
                    </path>`;

                    // Add label for larger features
                    if ((feature.end - feature.start) / totalLength > 0.03) {
                        const midAngle = (startAngle + endAngle) / 2;
                        const labelRadius = radius;
                        const labelX = centerX + labelRadius * Math.cos(midAngle);
                        const labelY = centerY + labelRadius * Math.sin(midAngle);

                        // Truncate label
                        const shortLabel = label.length > 12 ? label.substring(0, 10) + '..' : label;

                        svgContent += `<text x="${labelX}" y="${labelY}" text-anchor="middle"
                            dominant-baseline="middle" font-size="8" fill="#333" font-weight="500"
                            transform="rotate(${(midAngle * 180 / Math.PI) + 90}, ${labelX}, ${labelY})">${shortLabel}</text>`;
                    }
                }
            });

            // Center text
            svgContent += `<text x="${centerX}" y="${centerY - 10}" text-anchor="middle" font-size="12" font-weight="bold" fill="#333">${currentViewerVector.name}</text>`;
            svgContent += `<text x="${centerX}" y="${centerY + 10}" text-anchor="middle" font-size="11" fill="#666">${currentViewerVector.size.toLocaleString()} bp</text>`;

            svg.innerHTML = svgContent;
        }

        function updateLinearView() {
            if (!currentViewerVector) return;

            const svg = document.getElementById('linearView');
            const zoom = parseInt(document.getElementById('linearZoom').value);
            document.getElementById('zoomLevel').textContent = zoom + 'x';

            const totalLength = currentViewerVector.size;
            const pixelsPerBp = zoom;
            const width = totalLength * pixelsPerBp;
            const height = 200;
            const trackY = 80;
            const trackHeight = 30;

            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            let svgContent = '';

            // Draw backbone line
            svgContent += `<rect x="0" y="${trackY}" width="${width}" height="${trackHeight}" fill="#e0e0e0" rx="2"/>`;

            // Draw scale markers
            const markerInterval = zoom >= 5 ? 100 : (zoom >= 2 ? 500 : 1000);
            for (let pos = 0; pos <= totalLength; pos += markerInterval) {
                const x = pos * pixelsPerBp;
                svgContent += `<line x1="${x}" y1="${trackY + trackHeight}" x2="${x}" y2="${trackY + trackHeight + 8}" stroke="#999" stroke-width="1"/>`;
                svgContent += `<text x="${x}" y="${trackY + trackHeight + 20}" text-anchor="middle" font-size="10" fill="#666">${pos}</text>`;
            }

            // Draw features
            const displayFeatures = viewerFeatures.filter(f =>
                f.type !== 'source'
            );

            // Calculate feature tracks to avoid overlaps
            const tracks = [];
            displayFeatures.forEach(feature => {
                const x1 = feature.start * pixelsPerBp;
                const x2 = feature.end * pixelsPerBp;
                const featureWidth = Math.max(x2 - x1, 3);

                // Find available track
                let trackIndex = 0;
                for (let t = 0; t < tracks.length; t++) {
                    const lastEnd = tracks[t];
                    if (x1 > lastEnd + 5) {
                        trackIndex = t;
                        break;
                    }
                    trackIndex = t + 1;
                }
                if (trackIndex >= tracks.length) tracks.push(0);
                tracks[trackIndex] = x2;

                const y = trackY - (trackIndex + 1) * 20;
                const label = feature.qualifiers.label || feature.qualifiers.gene || feature.type;

                // Draw feature rectangle
                if (feature.complement) {
                    // Arrow pointing left
                    svgContent += `<polygon points="${x1},${y + 8} ${x1 + 8},${y} ${x2},${y} ${x2},${y + 16} ${x1 + 8},${y + 16}"
                        fill="${feature.color}" stroke="#333" stroke-width="0.5">
                        <title>${label}: ${feature.start}..${feature.end} (complement)</title>
                    </polygon>`;
                } else {
                    // Arrow pointing right
                    svgContent += `<polygon points="${x1},${y} ${x2 - 8},${y} ${x2},${y + 8} ${x2 - 8},${y + 16} ${x1},${y + 16}"
                        fill="${feature.color}" stroke="#333" stroke-width="0.5">
                        <title>${label}: ${feature.start}..${feature.end}</title>
                    </polygon>`;
                }

                // Add label if feature is wide enough
                if (featureWidth > 50) {
                    const shortLabel = label.length > featureWidth / 7 ? label.substring(0, Math.floor(featureWidth / 7)) + '..' : label;
                    svgContent += `<text x="${x1 + featureWidth / 2}" y="${y + 12}" text-anchor="middle" font-size="9" fill="#333">${shortLabel}</text>`;
                }
            });

            svg.innerHTML = svgContent;
        }

        function goToPosition() {
            const pos = parseInt(document.getElementById('gotoPosition').value);
            if (!pos || !currentViewerVector) return;

            const zoom = parseInt(document.getElementById('linearZoom').value);
            const scrollContainer = document.getElementById('linearViewScroll');
            const pixelsPerBp = zoom;
            scrollContainer.scrollLeft = (pos - 100) * pixelsPerBp;

            // Also update sequence view
            document.getElementById('seqStart').value = Math.max(1, pos - 250);
            document.getElementById('seqEnd').value = Math.min(currentViewerVector.size, pos + 250);
            updateSequenceView();
        }

        function updateSequenceView() {
            if (!currentViewerVector) return;

            const start = parseInt(document.getElementById('seqStart').value) || 1;
            const end = parseInt(document.getElementById('seqEnd').value) || 500;
            const sequence = currentViewerVector.sequence;

            const seqStart = Math.max(0, start - 1);
            const seqEnd = Math.min(sequence.length, end);
            const displaySeq = sequence.substring(seqStart, seqEnd);

            // Find features in this region
            const regionFeatures = viewerFeatures.filter(f =>
                f.start <= seqEnd && f.end >= seqStart && f.type !== 'source'
            );

            // Create colored sequence
            const seqView = document.getElementById('sequenceView');
            let html = '';

            // Display 60 bp per line
            const lineLength = 60;
            for (let i = 0; i < displaySeq.length; i += lineLength) {
                const lineStart = seqStart + i + 1;
                const lineSeq = displaySeq.substring(i, i + lineLength);

                html += '<div class="sequence-line">';
                html += `<span class="sequence-position">${lineStart}</span>`;
                html += '<span class="sequence-text">';

                // Color each nucleotide based on features
                for (let j = 0; j < lineSeq.length; j++) {
                    const absPos = seqStart + i + j + 1;
                    const nt = lineSeq[j];

                    // Find feature at this position
                    const feature = regionFeatures.find(f => absPos >= f.start && absPos <= f.end);
                    if (feature) {
                        html += `<span style="background-color: ${feature.color};" title="${feature.qualifiers.label || feature.type}: ${feature.start}..${feature.end}">${nt}</span>`;
                    } else {
                        html += nt;
                    }
                }

                html += '</span></div>';
            }

            seqView.innerHTML = html;
        }

        function showFullSequence() {
            if (!currentViewerVector) return;
            document.getElementById('seqStart').value = 1;
            document.getElementById('seqEnd').value = currentViewerVector.size;
            updateSequenceView();
        }

        // Initialize vector list on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadVectorList();
        });
    </script>
</body>
</html>
